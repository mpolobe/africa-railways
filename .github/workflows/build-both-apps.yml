name: Build Both Apps

on:
  # Automatic builds disabled due to EAS credit exhaustion
  # Re-enable after upgrading plan or January 1st reset
  # push:
  #   branches: [main]
  #   paths:
  #     - 'SmartphoneApp/**'
  #     - 'mobile/**'
  #     - 'src/**'
  #     - 'app.config.js'
  #     - 'eas.json'
  #     - 'package.json'
  workflow_dispatch:
    inputs:
      build_railways:
        description: 'Build Railways app'
        required: false
        default: true
        type: boolean
      build_africoin:
        description: 'Build Africoin app'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  build-railways:
    name: üöÇ Build Railways App
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ github.event.inputs.build_railways != 'false' }}
    defaults:
      run:
        working-directory: ./SmartphoneApp
    
    steps:
      - name: üîê Validate Required Secrets
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "‚ùå ERROR: EXPO_TOKEN secret is not set"
            echo "Please add EXPO_TOKEN to repository secrets at:"
            echo "https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          echo "‚úÖ All required secrets are present"

      - name: üèóÔ∏è Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: üèóÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './SmartphoneApp/package-lock.json'

      - name: üèóÔ∏è Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: üì¶ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: üîç Verify configuration
        run: |
          echo "üìã Checking EAS configuration..."
          cat eas.json | grep -A 10 "railways" || echo "No railways profile found in eas.json"
          echo ""
          echo "‚úÖ Configuration check complete"

      - name: üöÄ Build Railways App
        run: |
          echo "üöÇ Building Africa Railways Hub..."
          APP_VARIANT=railways eas build \
            --platform android \
            --profile railways \
            --non-interactive \
            --no-wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          APP_VARIANT: railways

      - name: üìä Build Summary
        run: |
          echo "## üöÇ Railways App Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ‚úÖ Build triggered successfully" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** Android" >> $GITHUB_STEP_SUMMARY
          echo "**Profile:** railways" >> $GITHUB_STEP_SUMMARY
          echo "**Bundle ID:** com.mpolobe.railways" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó [View build status](https://expo.dev/accounts/mpolobe/projects/africa-railways/builds)" >> $GITHUB_STEP_SUMMARY

  build-africoin:
    name: üí∞ Build Africoin App
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Removed 'needs: build-railways' to enable parallel execution
    if: ${{ github.event.inputs.build_africoin != 'false' }}
    defaults:
      run:
        working-directory: ./SmartphoneApp
    
    steps:
      - name: üîê Validate Required Secrets
        run: |
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "‚ùå ERROR: EXPO_TOKEN secret is not set"
            echo "Please add EXPO_TOKEN to repository secrets at:"
            echo "https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          echo "‚úÖ All required secrets are present"

      - name: üèóÔ∏è Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: üèóÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './SmartphoneApp/package-lock.json'

      - name: üèóÔ∏è Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: üì¶ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: üîç Verify configuration
        run: |
          echo "üìã Checking EAS configuration..."
          cat eas.json | grep -A 10 "africoin" || echo "No africoin profile found in eas.json"
          echo ""
          echo "‚úÖ Configuration check complete"

      - name: üöÄ Build Africoin App
        run: |
          echo "üí∞ Building Africoin Wallet..."
          APP_VARIANT=africoin eas build \
            --platform android \
            --profile africoin \
            --non-interactive \
            --no-wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          APP_VARIANT: africoin

      - name: üìä Build Summary
        run: |
          echo "## üí∞ Africoin App Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ‚úÖ Build triggered successfully" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** Android" >> $GITHUB_STEP_SUMMARY
          echo "**Profile:** africoin" >> $GITHUB_STEP_SUMMARY
          echo "**Bundle ID:** com.mpolobe.africoin" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó [View build status](https://expo.dev/accounts/mpolobe/projects/africoin-wallet/builds)" >> $GITHUB_STEP_SUMMARY

  notify:
    name: üì¢ Notify Build Status
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [build-railways, build-africoin]
    if: always()
    
    steps:
      - name: üìä Final Summary
        run: |
          echo "## üéâ Build Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build-railways.result }}" == "success" ]; then
            echo "‚úÖ **Railways App:** Build triggered successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Railways App:** Build failed or skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.build-africoin.result }}" == "success" ]; then
            echo "‚úÖ **Africoin App:** Build triggered successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Africoin App:** Build failed or skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì± Download Builds" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Visit the [Expo Dashboard](https://expo.dev/) to download your APKs once builds complete." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚è±Ô∏è Build Times" >> $GITHUB_STEP_SUMMARY
          echo "Builds typically take 10-15 minutes to complete." >> $GITHUB_STEP_SUMMARY

      - name: üîî Build Status
        run: |
          RAILWAYS_STATUS="${{ needs.build-railways.result }}"
          AFRICOIN_STATUS="${{ needs.build-africoin.result }}"
          
          echo "üöÇ Railways: $RAILWAYS_STATUS"
          echo "üí∞ Africoin: $AFRICOIN_STATUS"
          
          if [ "$RAILWAYS_STATUS" == "success" ] && [ "$AFRICOIN_STATUS" == "success" ]; then
            echo "‚úÖ All builds triggered successfully!"
            exit 0
          else
            echo "‚ö†Ô∏è Some builds failed or were skipped"
            exit 0
          fi
