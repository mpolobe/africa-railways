name: Test GCP Service Account Secret

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/test-gcp-secret.yml'

jobs:
  test-secret:
    name: Verify GCP Secret
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check secret exists
        run: |
          echo "Checking if GOOGLE_PLAY_SERVICE_ACCOUNT secret exists..."
          if [ -z "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}" ]; then
            echo "âŒ Secret GOOGLE_PLAY_SERVICE_ACCOUNT not found"
            exit 1
          else
            echo "âœ… Secret GOOGLE_PLAY_SERVICE_ACCOUNT exists"
          fi
      
      - name: Verify JSON structure
        run: |
          echo "Verifying JSON structure..."
          echo '${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}' > test-key.json
          
          # Check if valid JSON
          if ! jq empty test-key.json 2>/dev/null; then
            echo "âŒ Invalid JSON format"
            exit 1
          fi
          
          echo "âœ… Valid JSON format"
          
          # Check required fields
          echo "Checking required fields..."
          
          TYPE=$(jq -r '.type' test-key.json)
          PROJECT_ID=$(jq -r '.project_id' test-key.json)
          PRIVATE_KEY_ID=$(jq -r '.private_key_id' test-key.json)
          CLIENT_EMAIL=$(jq -r '.client_email' test-key.json)
          
          if [ "$TYPE" != "service_account" ]; then
            echo "âŒ Invalid type: $TYPE (expected: service_account)"
            exit 1
          fi
          echo "âœ… Type: $TYPE"
          
          if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" = "null" ]; then
            echo "âŒ Missing project_id"
            exit 1
          fi
          echo "âœ… Project ID: $PROJECT_ID"
          
          if [ -z "$PRIVATE_KEY_ID" ] || [ "$PRIVATE_KEY_ID" = "null" ]; then
            echo "âŒ Missing private_key_id"
            exit 1
          fi
          echo "âœ… Private Key ID: ${PRIVATE_KEY_ID:0:8}..."
          
          if [ -z "$CLIENT_EMAIL" ] || [ "$CLIENT_EMAIL" = "null" ]; then
            echo "âŒ Missing client_email"
            exit 1
          fi
          echo "âœ… Client Email: $CLIENT_EMAIL"
          
          # Check private key format
          if ! jq -r '.private_key' test-key.json | grep -q "BEGIN PRIVATE KEY"; then
            echo "âŒ Invalid private key format"
            exit 1
          fi
          echo "âœ… Private key format valid"
      
      - name: Cleanup
        if: always()
        run: |
          rm -f test-key.json
          echo "âœ… Cleanup complete"
      
      - name: Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                              â•‘"
          echo "â•‘   âœ…  GCP Service Account Secret Verified                   â•‘"
          echo "â•‘   âœ…  JSON Structure Valid                                  â•‘"
          echo "â•‘   âœ…  All Required Fields Present                           â•‘"
          echo "â•‘                                                              â•‘"
          echo "â•‘         ğŸš€ READY FOR PLAY STORE DEPLOYMENT! ğŸš€              â•‘"
          echo "â•‘                                                              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
